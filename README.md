# PeakForm

> AI-powered weekly performance intelligence for serious athletes.
> Garmin + MacroFactor → instant insights, smart recommendations, and a 7-day plan.

PeakForm is a personal fitness dashboard that turns raw wearable and nutrition
data into actionable coaching. Upload your weekly exports once, and the app
delivers a structured report, interactive charts, a live AI coach, and a
personalised training + meal plan — all in one dark-themed Streamlit interface.

---

## What the app does

### 1. Data ingestion
The user uploads two files via the sidebar:
- **MacroFactor `.xlsx`** — daily nutrition log (calories, protein, carbs, fat),
  scale weight, weight trend, expenditure, and manually-tracked muscle-group sets
- **Garmin `.csv`** — full activity log (running, strength, hiking, etc.)

The app parses both exports, classifies activities (flat runs, trail runs,
strength sessions), and identifies the most recent 7-day analysis window.

### 2. Weekly Report tab
A markdown report is generated by Claude (claude-haiku) using a structured
prompt grounded in the user's actual data.  It covers:
- Training load — mileage, pace, activity count
- Nutrition adherence — calories and protein vs. targets
- Body composition — weight trend toward goal
- Biofeedback — energy, motivation, recovery ratings entered via the sidebar

### 3. Charts tab
Eight interactive Plotly charts on a dark theme:
| Chart | What it shows |
|---|---|
| Plan Adherence | Four gauges: calorie days on-target, protein days hit, runs logged, strength sessions |
| Weight over Time | Daily scale readings + MacroFactor trend line toward goal weight |
| Weekly Mileage | Stacked bar — road/treadmill vs. trail miles per week |
| Daily Calories | Bar chart coloured green (on target) / grey (deficit) / red (surplus) vs. TDEE |
| Weekly Calorie Balance | Average surplus/deficit per week vs. TDEE |
| Daily Protein | Bar chart vs. protein target — green = hit, red = missed |
| Flat-Run Pace Trend | Scatter + 4-run rolling average; outliers > 15 min/mi are excluded |
| Strength by Muscle Group | Horizontal bar of sets per muscle group; priority groups highlighted green |

### 4. AI Coach (sidebar panel on every tab)
A persistent chat window backed by `PeakFormAgent` (claude-haiku).
The agent's system prompt is pre-loaded with the full weekly report and 30 days
of raw nutrition, weight, and activity tables so it can answer specific,
data-backed questions.
Conversation history is preserved in `st.session_state` and re-seeded into the
agent on session restore, so context survives container restarts.

### 5. Smart Plan tab
A 4-phase guided interview:
1. **Biofeedback** — collects energy, motivation, sleep, soreness ratings
2. **Analysis** — Claude analyses the ratings alongside training data and
   identifies imbalances or overreach
3. **Strategy proposal** — Claude proposes a training focus for the coming week
   (volume, intensity, recovery emphasis)
4. **7-day template** — a day-by-day plan with macro-verified meal suggestions
   and workout prescriptions, editable via chat

---

## Project layout

```
PeakForm-C/
├── app.py                      # Streamlit entry point — all UI logic
├── main.py                     # CLI entry point (non-Streamlit usage)
├── peakform/
│   ├── agent.py                # Orchestration: runs all analysers, builds result
│   ├── chat.py                 # PeakFormAgent — wraps Anthropic Messages API
│   ├── charts.py               # All Plotly figures (eight charts + theme constants)
│   ├── config.py               # User-specific targets, milestones, priority muscles
│   ├── persistence.py          # GCS-backed session save / restore
│   ├── recommendations.py      # Smart Plan interview state machine + Claude prompts
│   ├── analyzers/
│   │   ├── body_comp.py        # Weight trend analysis
│   │   ├── nutrition.py        # Calorie & macro adherence
│   │   ├── running.py          # Pace, mileage, flat vs. trail classification
│   │   ├── signals.py          # Biofeedback signal processing
│   │   └── strength.py         # Volume, muscle group tallying
│   ├── parsers/
│   │   ├── garmin.py           # Garmin CSV → GarminData (activities, runs, etc.)
│   │   └── macrofactor.py      # MacroFactor XLSX → MacroFactorData (nutrition, weight)
│   └── report/
│       └── formatter.py        # Markdown report template + Claude prompt
└── README.md
```

---

## Stack

| Layer | Technology |
|---|---|
| UI | [Streamlit](https://streamlit.io) |
| AI | [Anthropic Claude](https://anthropic.com) — haiku for chat/analysis, sonnet for plans |
| Charts | [Plotly](https://plotly.com) |
| Persistence | Google Cloud Storage (optional) |
| Deployment | Google Cloud Run |

---

## Setup & usage

```bash
pip install -r requirements.txt
streamlit run app.py
```

1. Add your `ANTHROPIC_API_KEY` to `.env` or Colab Secrets
2. Export **MacroFactor** data as `.xlsx` (Settings → Export Data)
3. Export **Garmin** activities as `.csv` from Garmin Connect
4. Upload both files in the sidebar and click **Run Analysis**
5. Explore the Report, Charts, and Smart Plan tabs

---

## Agent handoff

This section describes what an AI coding agent needs to know to continue
development safely.

### Key invariants
- **`config.py` is user-specific.** It contains hard-coded goal weight, target
  calories/protein, milestone dates, and priority muscle groups.  Never change
  these values without explicit user instruction.
- **`PeakFormAgent._history`** stores messages in `{"role": ..., "content": ...}`
  format — identical to the Anthropic Messages API.  It is seeded from
  `st.session_state.messages` on session restore so context is not lost.
- **Charts use a split `update_layout` pattern.** The theme dict `_BASE` is
  applied in one call; titles and axis labels are applied in a separate call
  using Plotly magic-underscore keys (`title_text`, `title_font_color`,
  `title_font_size`, `yaxis_title`).  Do **not** combine `**_BASE` and
  `title=...` in the same call — Plotly raises a TypeError on some versions.
- **Flat-run pace filter.** `pace_trend_chart` drops rows where
  `avg_pace > 15.0` min/mi before plotting and before computing the rolling
  average.  This is intentional — those points are hikes or GPS anomalies.

### Where to add features
| Goal | File(s) to touch |
|---|---|
| New chart | `peakform/charts.py` — add function, export it; `app.py` — import and render in `with tab_charts:` |
| New data source | `peakform/parsers/` — add parser; `peakform/agent.py` — include in `AnalysisResult` |
| New analyser | `peakform/analyzers/` — add module; `peakform/agent.py` — call in `run_full()` |
| Change AI model | `peakform/chat.py` `_DEFAULT_MODEL`; `peakform/recommendations.py` model strings |
| Change targets | `peakform/config.py` |
| UI layout | `app.py` — structured as sequential `with tab_*:` blocks |

### Session state keys (app.py)
| Key | Type | Purpose |
|---|---|---|
| `result` | `AnalysisResult` | Parsed data + report, set after Run Analysis |
| `messages` | `list[dict]` | AI coach chat history (user + assistant turns) |
| `agent` | `PeakFormAgent` | Live agent instance; `_history` mirrors `messages` |
| `rec` | `InterviewState` | Smart Plan interview progress |
| `biofeedback` | `dict` | Sidebar slider values |
| `api_key_input` | `str` | User-entered Anthropic key |

### Branch convention
Active development branch: `claude/fitness-nutrition-agent-Na3wd`
All agent commits should target this branch and be pushed with:
```bash
git push -u origin claude/fitness-nutrition-agent-Na3wd
```
